<VirtualHost *:80>
 ServerName {{ item.server_name }}
 {% if item.server_alias is defined %}
 ServerAlias {{ item.server_alias }}
 {% endif %}
 DocumentRoot {{ item.document_root }}

 <Directory "{{ item.document_root }}">
 AllowOverride All
 Require all granted
 </Directory>

 ErrorLog {{ apache_log_dir }}/{{ item.server_name }}_error.log
 CustomLog {{ apache_log_dir }}/{{ item.server_name }}_access.log combined

 {% if item.redirect_to_https is defined and item.redirect_to_https %}
 # Redirect all HTTP traffic to HTTPS
 RewriteEngine On
 RewriteCond %{HTTPS} off
 RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
 {% endif %}
</VirtualHost>
{% if item.ssl_enabled is defined and item.ssl_enabled %}
<VirtualHost *:443>
 ServerName {{ item.server_name }}
 {% if item.server_alias is defined %}
 ServerAlias {{ item.server_alias }}
 {% endif %}
 DocumentRoot {{ item.document_root }}

 <Directory "{{ item.document_root }}">
 AllowOverride All
 Require all granted
 </Directory>

 ErrorLog {{ apache_log_dir }}/{{ item.server_name }}_ssl_error.log
 CustomLog {{ apache_log_dir }}/{{ item.server_name }}_ssl_access.log combined

 # SSL Configuration
 SSLEngine on
 SSLCertificateFile {{ item.ssl_cert_path }}
 SSLCertificateKeyFile {{ item.ssl_key_path }}

 # Modern SSL configuration
 SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
 SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSAAES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
 SSLHonorCipherOrder off
 SSLSessionTickets off

 # Security headers
 Header always set X-Content-Type-Options nosniff
 Header always set X-Frame-Options DENY
 Header always set X-XSS-Protection "1; mode=block"
 Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
</VirtualHost>
{% endif %}
